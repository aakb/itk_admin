See the drupal version branchs for the actual code.
